$(document).ready(function(){var e=function(e,t){this.$el=null,this.$options={},this.$colSearch=null,this.$contentDiv=null,this.$activeView=null,this.$table=null,this.$unreadEmails=0;var i=this,a=e.find(".btn-compose"),n=e.find(".nav-menu"),o=function(e){e=$.extend({},$.fn.lobiMail.DEFAULT_OPTIONS,e);var t=$("[data-action=delete]");return t.length>0&&t.attr("href")&&"#"!==t.attr("href")&&(e.deleteUrl=t.attr("href")),i.$el.data("view-email-url")&&(e.viewEmailUrl=i.$el.data("view-email-url")),e},r=function(){T("beforeInit"),x(),i.debug("init method"),c(),d(),h(),y(),T("init")},c=function(){a.click(function(e){e.preventDefault(),i.showCompose()})},l=function(e){var t=e.data("type");["inbox","sent","draft","archive"].indexOf(t)>-1&&(i.$activeView=i.$el.find(".mailbox-table-wrapper"),i.$table=i.$activeView.find(".col-table table"),s()),"inbox"===t&&C(),V(i.$activeView)},d=function(){n.find("a").click(function(e){e.preventDefault();var t=$(this);if("#"!==t.attr("href")){var a=n.find("li.active"),o=a.find("a").data("type");T("beforeMenuChange",o),a.removeClass("active"),t.parent().addClass("active");var r=i.$colSearch.find("form").serialize();$.ajax(t.attr("href"),{method:"GET",data:r}).done(function(e){i.$contentDiv.html(e),l(t),T("afterMenuChange",o,t.data("type"))})}})},s=function(){var e=i.$table.find("tr td:first-child label");e.click(function(e){e.stopPropagation()}),e.find("input[type=checkbox]").on("change",function(e){var t=$(this);t.prop("checked")?$(e.currentTarget).closest("tr").addClass("selected"):$(e.currentTarget).closest("tr").removeClass("selected")}),f(),u(),p()},f=function(){if(i.$options.enableSelectAll){var e=i.$table.find("tr td:first-child input[type=checkbox]"),t=i.$el.find(i.$options.checkAllBtn);t.on("change",function(){e.prop("checked",$(this).prop("checked")),e.trigger("change")})}},u=function(){var e=i.$el.find(i.$options.checkAllBtn),t=i.$table.find("tbody");i.$el.find(".dropdown-select-type>li>a").click(function(i){i.preventDefault();var a=$(i.currentTarget);"all"===a.data("select")?(e.prop("checked",!0),e.trigger("change")):"none"===a.data("select")?(e.prop("checked",!1),e.trigger("change")):"read"===a.data("select")?(e.prop("checked",!1),e.trigger("change"),t.find("tr:not(.unread) td:first-child [type=checkbox]").prop("checked",!0).trigger("change")):"unread"===a.data("select")?(e.prop("checked",!1),e.trigger("change"),t.find("tr.unread td:first-child [type=checkbox]").prop("checked",!0).trigger("change")):"starred"===a.data("select")?(e.prop("checked",!1),e.trigger("change"),t.find("tr.starred td:first-child [type=checkbox]").prop("checked",!0).trigger("change")):"unstarred"===a.data("select")&&(e.prop("checked",!1),e.trigger("change"),t.find("tr:not(.starred) td:first-child [type=checkbox]").prop("checked",!0).trigger("change"))})},h=function(){i.$el.on("click","a[data-action]",function(e){e.preventDefault();var t=$(this);if("#"===t.attr("href"))return void i.debug("Url not specified for data-action "+t.data("action"));var a=t.data("action");"archive"===a||"spam"===a||"delete"===a&&i.deleteSelected()})},p=function(){return i.$options.enableStar?void i.$table.find(".td-star").click(function(e){var t=$(e.currentTarget);e.stopPropagation();var a=t.closest("tr");i.star([a.data("key")],!a.hasClass("starred"))}):void i.debug("Starring is disabled")},g=function(e){e.find(".compose-email-wrapper .compose-email-footer [data-action=discard_compose]").click(function(t){t.preventDefault(),e.find(".compose-email-wrapper .message-reply").destroy(),e.find(".compose-email-wrapper").css("display","none"),e.find(".ctr-img, .ctr-reply-or-forward").css("display","")})},m=function(e){e.find("form").on("submit",function(e){e.preventDefault();var t=$(e.currentTarget).closest("form"),i=t.serializeArray(),a=$("<div>"+t.find(".message-reply").code()+"</div>");a.find(".reply-text").remove(),i[1].value=a.html(),$.ajax(t.attr("action"),{method:t.attr("method"),data:i,complete:function(e,t){window.console.log(e,t)}})})},v=function(e){e.find(".ctr-reply-or-forward .inner-text").click(function(){var t=(i.$activeView.find(".row-sender .col-email-date").html(),i.$activeView.find(".row-sender .ctr-name-email .name").html(),i.$activeView.find(".row-sender .ctr-name-email .email")),a=(t.html()?"&lt;"+t.html()+"&gt;":"","");b(e,a)}),i.$activeView.find("[data-action=reply]").click(function(){e.find(".ctr-reply-or-forward .inner-text").trigger("click")})},b=function(e){e.find(".ctr-img, .ctr-reply-or-forward").css("display","none"),e.find(".compose-email-wrapper").css("display","block").find(".message-reply").summernote({focus:!0})},w=function(){i.$activeView=i.$contentDiv.find(".mailbox-compose-email");var e=i.$contentDiv.find(".row-header");e.find(".form-group.to select").select2({placeholder:"To"}),e.find(".form-group.cc select").select2({placeholder:"Cc"}),e.find(".form-group.bcc select").select2({placeholder:"Bcc"}),i.$contentDiv.find(".row-body .summernote").summernote({}),e.find(".form-group.to .show-cc-bcc .show-cc").click(function(){e.find(".form-group.cc").toggleClass("hide"),$(this).parent().attr("stay","true").show()}),e.find(".form-group.to .show-cc-bcc .show-bcc").click(function(){e.find(".form-group.bcc").toggleClass("hide"),$(this).parent().attr("stay","true").show()}),i.$contentDiv.find("form button").click(function(e){e.preventDefault()})},y=function(){if(i.$options.defaultView){var e=i.$options.defaultView.toLowerCase();"compose"===e?i.showCompose():"email"===e&&i.$options.defaultMessageKey?i.viewEmail(i.$options.defaultMessageKey):n.find("a[data-type="+e+"]").trigger("click")}},k=function(){var e=i.$el.find(i.$options.goBackBtn);return 0===e.length?void i.debug("Back button does not exist"):void e.click(function(){i.goBack()})},x=function(){i.$options.enableSearch&&i.$colSearch.find("form").on("submit",function(e){e.preventDefault(),i.search()})},V=function(e){return i.$options.enableTooltips?void e.find("[data-toggle=tooltip]").tooltip({container:i.$el}):void i.debug("Tooltips are disabled")},C=function(){i.debug("Inbox initialized"),i.$unreadEmails=parseInt(i.$activeView.data("unread-emails"),10)||0,i.setInboxBadgeValue(i.$unreadEmails),i.$table.find("tr").click(function(e){var t=$(e.currentTarget);i.viewEmail(t.data("key"))})},S=function(){var e=i.$activeView.find(".row-reply-or-forward");g(e),m(e),v(e),D(!0)},D=function(e){var t=i.$activeView.find(".row-conversation .row-message .row-sender");return t.off("click"),e&&t.click(function(){var e=$(this),t=e.closest(".row-message").toggleClass("collapsed");if(t.find(".row-body").slideToggle(200),t.hasClass("collapsed")){var i=t.find(".row-body .body-text").html();i=i.replace(/(<([^>]+)>)/gi," ").substr(0,130),e.find(".ctr-body-text").html(i)}else e.find(".ctr-body-text").html("")}),i},E=function(){i.$activeView=i.$contentDiv.find(".mailbox-message-view"),k(),V(i.$activeView),S()},T=function(e){var t=Array.prototype.slice.call(arguments,1);t.unshift(i),i.$el.trigger(e+".lobiMail",t)};this.showCompose=function(){return T("beforeShowCompose"),n.find("li.active").removeClass("active"),i.$activeView&&i.$activeView.hasClass("mailbox-compose-email")||i.$contentDiv.load(a.attr("href"),function(){w(),T("showCompose")}),i},this.showInbox=function(){return n.find("a[data-type=inbox]").trigger("click"),i},this.showSent=function(){return n.find("a[data-type=sent]").trigger("click"),i},this.search=function(){if(!i.$options.enableSearch)return i.debug("Search is disabled"),i;if(!i.$activeView||i.$activeView.hasClass("mailbox-table-wrapper"))return n.find("li.active a").trigger("click"),i},this.getSelected=function(){return i.$table.find("tr.selected")},this.getSelectedIds=function(){var e=i.getSelected(),t=[];return e.each(function(e,i){t.push($(i).data("key"))}),t},this.deleteSelected=function(){return i.deleteEmails(i.getSelectedIds()),i},this.deleteEmails=function(e){function t(){for(var t=0;t<e.length;t++)i.$table.find("tr[data-key="+e[t]+"]").remove()}return T("beforeDelete",e),0===e.length?i:i.$options.deleteUrl?($.ajax(i.$options.deleteUrl,{method:"POST",data:data}).done(function(i){i.success&&(t(),T("afterDelete",e))}),i):(t(),i)},this.setInboxBadgeValue=function(e){var t=n.find("a[data-type=inbox] .badge-unread"),a=t.html()||0;return 0>=e?t.hide():(t.show(),t.html(e)),T("inboxBadgeChange",a,e),i},this.decreaseInboxBadge=function(){return 0===i.$unreadEmails?i:(i.setInboxBadgeValue(--i.$unreadEmails),i)},this.viewEmail=function(e){return T("beforeEmailView",e),i.$table&&i.$table.data("view-email-url")&&(i.$options.viewEmailUrl=i.$table.data("view-email-url")),i.$options.viewEmailUrl?($.ajax(i.$options.viewEmailUrl,{method:"GET",data:{key:e}}).done(function(t){if(i.$table){var a=i.$table.find("tr[data-key="+e+"]");a.hasClass("unread")&&i.decreaseInboxBadge()}i.$contentDiv.html(t),E(),i.$activeView.attr("data-email-key",e),T("afterEmailView",e)}),i):i},this.star=function(e,t){function a(){for(var t=0;t<e.length;t++)i.$table.find("[data-key="+e[t]+"]").toggleClass("starred").find(".td-star .fa").toggleClass("fa-star-o").toggleClass("fa-star")}return T("beforeStarChange",e,t),0===e.length?i:i.$options.starEmailUrl?($.ajax(i.$options.starEmailUrl,{method:"POST",data:{ids:e,star:t}}).done(function(i){i.success&&(a(),T("afterStarChange",e,t))}),i):(a(),i)},this.goBack=function(){var e=n.find("li.active a").data("type")||"inbox";return n.find('li>a[data-type="'+e+'"]').trigger("click"),i},this.setDefaultView=function(e,t){return i.$options.defaultView=e,t&&(i.$options.defaultMessageKey=t),i},this.debug=function(){return i.$options.enableDebug?(window.console.info.apply(window.console,arguments),i):i},this.error=function(){window.console.error.apply(window.console,arguments)},i.$el=e,i.$colSearch=this.$el.find(".col-search"),i.$contentDiv=e.find(".col-content"),t=o(t),this.$options=t,r()};$.fn.lobiMail=function(t){return this.each(function(){var i=$(this),a=i.data("lobiMail"),n="object"==typeof t&&t;a||i.data("lobiMail",a=new e(i,n)),"string"==typeof t&&a[t]()})},$.fn.lobiMail.DEFAULT_OPTIONS={enableSearch:!0,enableSelectAll:!0,enableDebug:!1,enableStar:!0,enableTooltips:!0,defaultView:"inbox",defaultMessageKey:!1,deleteUrl:"",viewEmailUrl:"",starEmailUrl:"",goBackBtn:'[data-action="go-back"]',checkAllBtn:'[data-action="select-all"]'},$(".lobimail").lobiMail()});